<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<title data-i18n-key="page_title_transactions">Transaction Log</title>
<link rel="stylesheet" data-href="/styles/transactions.css">
<script>
    (function() {
        const link = document.querySelector('link[data-href]');
        if (!link) return;
        const href = link.getAttribute('data-href');
        link.setAttribute('href', location.protocol === 'file:' ? href.replace(/^\//, '') : href);
    })();
</script>
<script src="chart.js"></script>
</head>
<script>
    (function() {
        if (location.protocol !== 'file:') return;
        const routeMap = {
            '/': 'barcode_receiver.html',
            '/add-product': 'add_product.html',
            '/item-list': 'item_list.html',
            '/transactions': 'transactions.html',
            '/reports': 'reports.html',
            '/categories': 'categories.html' // Make sure this is here
        };
        document.querySelectorAll('a[href^="/"]').forEach(a => {
            const href = a.getAttribute('href');
            if (!href) return;
            if (href.startsWith('/edit-product/')) {
                const barcode = href.split('/').pop();
                a.setAttribute('href', `edit_product.html?barcode=${encodeURIComponent(barcode)}`);
            } else if (href.startsWith('/item-history/')) {
                const barcode = href.split('/').pop();
                a.setAttribute('href', `item_history.html?barcode=${encodeURIComponent(barcode)}`);
            } else {
                const base = href.split('?')[0].replace(/\/$/, '');
                if (routeMap[base]) a.setAttribute('href', routeMap[base]);
            }
        });
    })();
</script>

<body>
    <nav id="sidebar">
        <div id="lang-switcher">
            <button id="lang-en">EN</button>
            <button id="lang-th">TH</button>
        </div>
        <h2 data-i18n-key="nav_menu">Menu</h2>
        <ul>
            <li><a href="barcode_receiver.html" data-i18n-key="nav_inventory">üìä Inventory</a></li>
            <li><a href="/add-product" data-i18n-key="nav_add_product">‚ûï Add Product</a></li>
            <li><a href="/item-list" data-i18n-key="nav_item_list">üìù Item List</a></li>
            <li><a href="/categories" data-i18n-key="nav_categories">üóÇÔ∏è Categories</a></li>
            <li><a href="/transactions" class="active" data-i18n-key="nav_transactions">üìà Transactions</a></li>
            <li><a href="/reports" data-i18n-key="nav_reports">üìÑ Reports</a></li>
        </ul>
    </nav>

    <main id="main-content">
        <div class="container">
            <h1 data-i18n-key="transactions_title">Transaction History</h1>

            <div id="summary-box">
                <div class="summary-item">
                    <span class="summary-label" data-i18n-key="transactions_summary_added">Items Added:</span>
                    <span id="summary-added" class="summary-value summary-add">0</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label" data-i18n-key="transactions_summary_cut">Items Cut:</span>
                    <span id="summary-cut" class="summary-value summary-cut">0</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label" data-i18n-key="transactions_summary_adjusted">Net Change:</span>
                    <span id="summary-net" class="summary-value summary-adjust">0</span>
                </div>
            </div>

            <div id="controls">
                <div id="search-area">
                    <label for="searchCategory" data-i18n-key="transactions_search_by">Search By:</label>
                    <select id="searchCategory"> 
                        <option value="name" data-i18n-key="transactions_search_name">Item Name</option> 
                        <option value="date" data-i18n-key="transactions_search_date">Date</option> 
                        <option value="type" data-i18n-key="transactions_search_type">Type (Add/Cut)</option> 
                    </select>
                    <input type="text" id="searchNameInput" placeholder="Enter item name..." data-i18n-key="transactions_placeholder_name" data-i18n-placeholder="true">
                    <input type="date" id="searchDateInput" style="display: none;">
                    <input type="text" id="searchTypeInput" placeholder="Enter 'Add' or 'Cut'" data-i18n-key="transactions_placeholder_type" data-i18n-placeholder="true" style="display: none;">
                    <div id="suggestions"></div>
                </div>
                <button id="exportButton" data-i18n-key="transactions_export_csv">Export to CSV</button>
            </div>

            <div id="table-container">
                <table id="transactionTable">
                    <thead>
                        <tr>
                            <th data-i18n-key="transactions_table_date">Date</th>
                            <th data-i18n-key="transactions_table_time">Time</th>
                            <th data-i18n-key="transactions_table_item">Item Name (Size)</th>
                            <th data-i18n-key="transactions_table_type">Type</th>
                            <th data-i18n-key="transactions_table_amount">Amount</th>
                            <th data-i18n-key="transactions_table_cost">Cost (ea.)</th>
                            <th data-i18n-key="transactions_table_total_cost">Total Cost</th>
                            <th data-i18n-key="transactions_table_new_stock">New Stock</th>
                            <th data-i18n-key="transactions_table_delete">Delete</th>
                        </tr>
                    </thead>
                    <tbody id="transactionTableBody">
                        <tr>
                            <td colspan="9" style="text-align: center;" data-i18n-key="transactions_loading">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="container">
            <h2 data-i18n-key="transactions_graph_title">Transaction Graph</h2>
            <div id="graphContainer"> <canvas id="transactionChart"></canvas> </div>
        </div>
    </main>
    <div id="deleteTransactionModal" class="modal-overlay">
        <div class="modal-content">
            <h3 data-i18n-key="modal_delete_transaction_title">Confirm Delete Transaction</h3>
            <p id="deleteTransactionText"></p>
            <input type="hidden" id="deleteTransactionTimestamp">

            <div class="modal-buttons">
                <button type="button" id="cancelDeleteTxBtn" class="modal-cancel-btn" data-i18n-key="modal_delete_cancel">Cancel</button>
                <button type="button" id="confirmDeleteTxBtn" class="modal-delete-btn" data-i18n-key="transactions_table_delete">Delete</button>
            </div>
        </div>
    </div>

    <div id="toastNotification" class="toast"> <span id="toastMessage"></span> </div>

    <script type="module" data-src="/scripts/transactions.js"></script>
</body>

<script type="module" data-src="/scripts/transactions.js"></script>
<script>
    (function() {
        // set script src attributes
        const scripts = document.querySelectorAll('script[data-src]');
        scripts.forEach(s => {
            const d = s.getAttribute('data-src');
            if (!d) return;
            s.setAttribute('src', location.protocol === 'file:' ? d.replace(/^\//, '') : d);
        });

        // set anchor hrefs from data-href
        document.querySelectorAll('a[data-href]').forEach(a => {
            const data = a.getAttribute('data-href');
            if (!data) return;
            a.setAttribute('href', location.protocol === 'file:' ? data.replace(/^\//, '') : data);
        });

        // when under file://, rewrite server-style links to local filenames
        if (location.protocol !== 'file:') return;
        const routeMap = {
            '/': 'barcode_receiver.html',
            '/add-product': 'add_product.html',
            '/edit-product': 'edit_product.html',
            '/item-list': 'item_list.html',
            '/item-history': 'item_history.html',
            '/transactions': 'transactions.html',
            '/reports': 'reports.html',
            '/categories': 'categories.html'
        };
        document.querySelectorAll('a[href^="/"]').forEach(a => {
            const href = a.getAttribute('href');
            if (!href) return;
            if (href.startsWith('/edit-product/')) {
                const barcode = href.split('/').pop();
                a.setAttribute('href', `edit_product.html?barcode=${encodeURIComponent(barcode)}`);
            } else if (href.startsWith('/item-history/')) {
                const barcode = href.split('/').pop();
                a.setAttribute('href', `item_history.html?barcode=${encodeURIComponent(barcode)}`);
            } else {
                const base = href.split('?')[0].replace(/\/$/, '');
                if (routeMap[base]) a.setAttribute('href', routeMap[base]);
            }
        });
    })();
</script>
</body>

</html>