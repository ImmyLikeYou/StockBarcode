<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n-key="page_title_item_history">Item History</title>
    <link rel="stylesheet" data-href="/styles/item_history.css">
    <script>
        (function() {
            const link = document.querySelector('link[data-href]');
            if (!link) return;
            const href = link.getAttribute('data-href');
            link.setAttribute('href', location.protocol === 'file:' ? href.replace(/^\//, '') : href);
        })();
    </script>
</head>

<body>
    <nav id="sidebar">
        <div id="lang-switcher">
            <button id="lang-en">EN</button>
            <button id="lang-th">TH</button>
        </div>
        <h2 data-i18n-key="nav_menu">Menu</h2>
        <ul>
            <li><a href="barcode_receiver.html" data-i18n-key="nav_inventory">üìä Inventory</a></li>
            <li><a href="/add-product" data-i18n-key="nav_add_product">‚ûï Add Product</a></li>
            <li><a href="/item-list" class="active" data-i18n-key="nav_item_list">üìù Item List</a></li>
            <li><a href="/categories" data-i18n-key="nav_categories">üóÇÔ∏è Categories</a></li>
            <li><a href="/transactions" data-i18n-key="nav_transactions">üìà Transactions</a></li>
            <li><a href="/reports" data-i18n-key="nav_reports">üìÑ Reports</a></li>
        </ul>
    </nav>

    <main id="main-content">
        <div class="container">
            <a data-href="/item-list" class="back-link" data-i18n-key="history_back_link">&larr; Back to Item List</a>
            <h1 id="historyTitle" data-i18n-key="history_title">Transaction History</h1>
            <p><strong data-i18n-key="history_barcode_label">Barcode: </strong><span id="historyBarcode"></span></p>

            <div class="filter-controls">
                <label for="historyDateFilter" data-i18n-key="history_filter_date">Filter by Date:</label>
                <input type="date" id="historyDateFilter">
                <button id="clearHistoryFilter" data-i18n-key="history_show_all_button">Show All</button>
            </div>
            <table id="historyTable">
                <thead>
                    <tr>
                        <th data-i18n-key="history_table_date">Date</th>
                        <th data-i18n-key="history_table_time">Time</th>
                        <th data-i18n-key="history_table_size">Size</th>
                        <th data-i18n-key="history_table_type">Type</th>
                        <th data-i18n-key="history_table_amount">Amount Changed</th>
                        <th data-i18n-key="history_table_new_stock">New Stock (Size)</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    <tr>
                        <td colspan="6" style="text-align: center;" data-i18n-key="history_loading">Loading history...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <script>
        // Support ?barcode=123 or path /item-history/123
        function getBarcodeFromUrl() {
            const params = new URLSearchParams(window.location.search);
            let bc = params.get('barcode');
            if (bc) return bc;
            const path = window.location.pathname || '';
            const parts = path.split('/').filter(Boolean);
            if (parts.length > 0) {
                const last = parts[parts.length - 1];
                if (!last.match(/^item-history(\.html)?$/i)) return last;
            }
            if (window.location.hash) {
                const h = window.location.hash.replace('#', '');
                if (h) return h;
            }
            return null;
        }
        const productBarcode = getBarcodeFromUrl();
        // This script runs before i18n, so we just set the barcode number
        // The i18n.js will handle setting the "Barcode:" label
        const historyBarcodeEl = document.getElementById('historyBarcode');
        if (productBarcode) {
            historyBarcodeEl.textContent = productBarcode;
        } else {
            // Error case, i18n will handle the title translation
            document.getElementById('historyTitle').setAttribute('data-i18n-key', 'history_error_no_barcode');
        }
    </script>
    <script type="module" data-src="/scripts/item_history.js"></script>
    <script>
        (function() {
            // set script src attributes
            const scripts = document.querySelectorAll('script[data-src]');
            scripts.forEach(s => {
                const d = s.getAttribute('data-src');
                if (!d) return;
                s.setAttribute('src', location.protocol === 'file:' ? d.replace(/^\//, '') : d);
            });

            // set anchor hrefs from data-href
            document.querySelectorAll('a[data-href]').forEach(a => {
                const data = a.getAttribute('data-href');
                if (!data) return;
                a.setAttribute('href', data);
            });

            // when under file://, rewrite server-style links to local filenames
            if (location.protocol !== 'file:') return;
            const routeMap = {
                '/': 'barcode_receiver.html',
                '/add-product': 'add_product.html',
                '/edit-product': 'edit_product.html',
                '/item-list': 'item_list.html',
                '/item-history': 'item_history.html',
                '/transactions': 'transactions.html',
                '/reports': 'reports.html',
                '/categories': 'categories.html'
            };
            document.querySelectorAll('a[href^="/"]').forEach(a => {
                const href = a.getAttribute('href');
                if (!href) return;
                if (href.startsWith('/edit-product/')) {
                    const barcode = href.split('/').pop();
                    a.setAttribute('href', `edit_product.html?barcode=${encodeURIComponent(barcode)}`);
                } else if (href.startsWith('/item-history/')) {
                    const barcode = href.split('/').pop();
                    a.setAttribute('href', `item_history.html?barcode=${encodeURIComponent(barcode)}`);
                } else {
                    const base = href.split('?')[0].replace(/\/$/, '');
                    if (routeMap[base]) a.setAttribute('href', routeMap[base]);
                }
            });
        })();
    </script>
</body>

</html>